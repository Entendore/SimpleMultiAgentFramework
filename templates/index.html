<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Agent AI Studio</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #0f172a;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --border-radius: 12px;
      --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: all 0.2s ease-in-out;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: var(--gray-800);
      line-height: 1.6;
    }

    /* Header Styles */
    header {
      background: linear-gradient(120deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: var(--box-shadow-lg);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-title h1 {
      font-weight: 700;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-subtitle {
      font-size: 1rem;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Main Layout */
    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 1.5rem;
      min-height: calc(100vh - 200px);
    }

    @media (max-width: 1200px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Panel Styles */
    .panel {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--gray-100);
    }

    .panel-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Assistant Showcase */
    .assistants-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      padding: 1rem 0;
    }

    .assistant-card {
      background: var(--gray-50);
      border-radius: var(--border-radius);
      padding: 1.25rem 1rem;
      text-align: center;
      transition: var(--transition);
      border: 2px solid transparent;
      cursor: pointer;
    }

    .assistant-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-lg);
      border-color: var(--primary);
    }

    .assistant-card.active {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .assistant-avatar {
      font-size: 2rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      margin: 0 auto 0.75rem;
      background: white;
      border-radius: 50%;
      box-shadow: var(--box-shadow);
    }

    .assistant-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
      color: var(--gray-900);
    }

    .assistant-task {
      font-size: 0.8rem;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .assistant-model {
      background: var(--gray-200);
      color: var(--gray-700);
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .assistant-actions {
      display: flex;
      justify-content: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }

    .assistant-btn {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .assistant-btn.edit {
      background: var(--primary);
      color: white;
    }

    .assistant-btn.edit:hover {
      background: var(--primary-dark);
    }

    /* Chain Builder */
    .chain-builder {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .chain-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chain-palette {
      background: var(--gray-50);
      border-radius: var(--border-radius);
      padding: 1.25rem;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
    }

    .chain-palette-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
    }

    .chain-agent {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      text-align: center;
      cursor: grab;
      transition: var(--transition);
      border: 2px solid var(--gray-200);
    }

    .chain-agent:hover {
      border-color: var(--primary);
      transform: scale(1.02);
    }

    .chain-agent:active {
      cursor: grabbing;
    }

    .chain-builder-area {
      background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
      border: 2px dashed var(--primary);
      border-radius: var(--border-radius);
      min-height: 150px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .chain-placeholder {
      text-align: center;
      color: var(--gray-500);
    }

    .chain-placeholder i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--primary);
      opacity: 0.3;
    }

    .chain-visualization {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .chain-node {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }

    .chain-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      box-shadow: var(--box-shadow);
      position: relative;
    }

    .chain-step {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--primary);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .chain-name {
      font-size: 0.85rem;
      font-weight: 500;
      text-align: center;
      max-width: 80px;
    }

    .chain-arrow {
      font-size: 1.5rem;
      color: var(--primary);
      font-weight: bold;
    }

    .chain-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.6rem 1.25rem;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-800);
    }

    .btn-secondary:hover {
      background: var(--gray-300);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #0da271;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* Chat Panel */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: var(--border-radius);
      margin-bottom: 1.5rem;
    }

    .message {
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      border-radius: var(--border-radius);
      max-width: 85%;
      position: relative;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-user {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message-agent {
      background: white;
      color: var(--gray-800);
      border: 1px solid var(--gray-200);
      border-bottom-left-radius: 4px;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .message-avatar {
      font-size: 1.2rem;
    }

    .message-content {
      line-height: 1.6;
    }

    .chat-input {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }

    .chat-input-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      min-height: 80px;
      max-height: 200px;
      transition: var(--transition);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    select {
      padding: 0.75rem;
      border: 2px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-family: inherit;
      font-size: 0.95rem;
      background: white;
      transition: var(--transition);
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Accordion Styles */
    .accordion {
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .accordion-item {
      border-bottom: 1px solid var(--gray-200);
    }

    .accordion-item:last-child {
      border-bottom: none;
    }

    .accordion-header {
      padding: 1rem 1.25rem;
      background: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      transition: var(--transition);
    }

    .accordion-header:hover {
      background: var(--gray-50);
    }

    .accordion-content {
      padding: 0 1.25rem;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      background: var(--gray-50);
    }

    .accordion-item.active .accordion-content {
      padding: 1.25rem;
      max-height: 1000px;
    }

    .accordion-icon {
      transition: transform 0.3s ease;
    }

    .accordion-item.active .accordion-icon {
      transform: rotate(180deg);
    }

    /* Model Status */
    .model-status {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-radius: var(--border-radius);
      margin-top: 0.5rem;
    }

    .status-item {
      display: flex;
      flex-direction: column;
      min-width: 120px;
    }

    .status-label {
      font-size: 0.85rem;
      color: var(--gray-600);
      margin-bottom: 0.25rem;
    }

    .status-value {
      font-weight: 600;
      font-size: 1rem;
    }

    .status-good {
      color: var(--success);
    }

    .status-warning {
      color: var(--warning);
    }

    .status-danger {
      color: var(--danger);
    }

    /* Search Results */
    .search-results {
      max-height: 200px;
      overflow-y: auto;
      background: var(--gray-50);
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-top: 0.5rem;
    }

    /* Presets */
    .presets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .preset-card {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      padding: 1rem;
      transition: var(--transition);
    }

    .preset-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .preset-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--gray-900);
    }

    .preset-chain {
      font-size: 0.85rem;
      color: var(--gray-600);
      margin-bottom: 0.75rem;
      min-height: 1.2rem;
    }

    .preset-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Warning Banner */
    .warning-banner {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .warning-banner p {
      margin: 0;
      color: #92400e;
      font-weight: 500;
    }

    .warning-banner code {
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: monospace;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .layout-grid {
        gap: 1rem;
      }

      .panel {
        padding: 1.25rem;
      }

      .message {
        max-width: 95%;
      }

      .chain-visualization {
        gap: 1rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <div class="header-title">
        <i class="fas fa-robot"></i>
        <div>
          <h1>Multi-Agent AI Studio</h1>
          <p class="header-subtitle">Local Ollama-powered multi-agent system with intelligent model management</p>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="layout-grid">
      <!-- Left Panel -->
      <div class="panel">
        <div class="warning-banner" id="modelWarning" style="display:none;">
          <p>‚ö†Ô∏è Some recommended models are missing: <code>ollama pull phi3</code> &
            <code>ollama pull nomic-embed-text</code>
          </p>
        </div>

        <!-- Assistants Showcase -->
        <div class="accordion">
          <div class="accordion-item active">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span><i class="fas fa-users"></i> Available Assistants</span>
              <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
              <div class="assistants-grid" id="agentShowcase">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Chain Builder -->
          <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span><i class="fas fa-link"></i> Agent Chain Builder</span>
              <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
              <div class="chain-builder">
                <div class="chain-section">
                  <div class="panel-header">
                    <h3 class="panel-title"><i class="fas fa-brain"></i> Available Agents</h3>
                  </div>
                  <div class="chain-palette">
                    <div class="chain-palette-grid" id="agentPalette">
                      <!-- Populated by JavaScript -->
                    </div>
                  </div>
                </div>

                <div class="chain-section">
                  <div class="panel-header">
                    <h3 class="panel-title"><i class="fas fa-project-diagram"></i> Your Chain</h3>
                    <span id="chainLength" class="status-value"></span>
                  </div>
                  <div class="chain-builder-area" id="chainVisualization">
                    <div class="chain-placeholder" id="chainPlaceholder">
                      <i class="fas fa-infinity"></i>
                      <p>Drag agents from above to build your chain</p>
                      <p style="font-size: 0.9rem; margin-top: 0.5rem;">Example: Math ‚Üí Writing ‚Üí Pirate</p>
                    </div>
                    <div class="chain-visualization" id="chainNodes"></div>
                  </div>
                  <div class="chain-actions">
                    <button class="btn btn-danger" onclick="clearChain()">
                      <i class="fas fa-trash"></i> Clear Chain
                    </button>
                    <button class="btn btn-success" onclick="saveChainPreset()">
                      <i class="fas fa-save"></i> Save Preset
                    </button>
                    <button class="btn btn-primary" onclick="buildChainMessage()">
                      <i class="fas fa-play"></i> Execute Chain
                    </button>
                  </div>
                </div>

                <!-- Presets -->
                <div class="chain-section">
                  <div class="panel-header">
                    <h3 class="panel-title"><i class="fas fa-bookmark"></i> Saved Presets</h3>
                  </div>
                  <div class="presets-grid" id="presetList">
                    <!-- Populated by JavaScript -->
                  </div>
                </div>

                <!-- Export/Import -->
                <div class="chain-section">
                  <div class="panel-header">
                    <h3 class="panel-title"><i class="fas fa-file-export"></i> Transfer Chains</h3>
                  </div>
                  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="exportChainPresets()">
                      <i class="fas fa-file-export"></i> Export (.json)
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                      <i class="fas fa-file-import"></i> Import (.json)
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display:none;"
                      onchange="importChainPresets(event)">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Model Status -->
          <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span><i class="fas fa-memory"></i> Model Memory Status</span>
              <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
              <div class="model-status" id="modelStatus">
                <div class="status-item">
                  <span class="status-label">Active Models</span>
                  <span class="status-value">Loading...</span>
                </div>
                <div class="status-item">
                  <span class="status-label">RAM Usage</span>
                  <span class="status-value">Loading...</span>
                </div>
                <div class="status-item">
                  <span class="status-label">Capacity</span>
                  <span class="status-value">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Search -->
          <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span><i class="fas fa-search"></i> Semantic Search</span>
              <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
              <input type="text" id="searchQuery" placeholder="Search current or all chats..." class="form-control" />
              <div style="display: flex; gap: 0.75rem; margin-top: 0.75rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="searchCurrent()">Current Session</button>
                <button class="btn btn-secondary" onclick="searchGlobal()">All Sessions</button>
              </div>
              <div class="search-results" id="searchResults"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Chat -->
      <div class="panel chat-container">
        <div class="chat-messages" id="chat"></div>
        <div class="chat-input">
          <div class="chat-input-group">
            <textarea id="message" placeholder="Ask about code, writing, math, or anything! Try [CHAIN:math,pirate] 2+2"
              autocomplete="off"></textarea>
            <select id="agent">
              <option value="">Auto-select Assistant</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <button class="btn btn-primary" onclick="sendMessage()" style="height: fit-content;">
              <i class="fas fa-paper-plane"></i> Send
            </button>
            <button class="btn btn-danger" onclick="clearChat()" style="height: fit-content;">
              <i class="fas fa-trash"></i> Clear
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Swap Guide Modal -->
  <div id="swapModal" style="
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:rgba(0,0,0,0.7); 
    z-index:1000;
    justify-content:center;
    align-items:center;
  ">
    <div style="
      background:white; 
      padding:2rem; 
      border-radius:16px; 
      max-width:800px; 
      max-height:80vh; 
      overflow-y:auto;
      width:90%;
      box-shadow: var(--box-shadow-lg);
    ">
      <h3 id="swapGuideTitle" style="margin-bottom: 1.5rem; color: var(--gray-900);">Swap File Setup Guide</h3>
      <div id="swapGuideContent"></div>
      <button onclick="document.getElementById('swapModal').style.display='none'"
        style="margin-top:1.5rem; background:var(--primary); color:white; padding:0.75rem 1.5rem; border:none; border-radius:12px; font-weight:600; width:100%;">
        Close Guide
      </button>
    </div>
  </div>

  <script>
    // Accordion functionality
    function toggleAccordion(header) {
      const item = header.parentElement;
      const isActive = item.classList.contains('active');

      // Close all other items
      document.querySelectorAll('.accordion-item').forEach(el => {
        el.classList.remove('active');
      });

      // Toggle current item
      if (!isActive)
      {
        item.classList.add('active');
      }
    }

    const chatBox = document.getElementById("chat");
    const searchResults = document.getElementById("searchResults");

    // Agent avatar map
    const AGENT_AVATARS = {
      "math": { emoji: "üßÆ", color: "#28a745" },
      "code": { emoji: "üíª", color: "#0078d4" },
      "writing": { emoji: "‚úçÔ∏è", color: "#17a2b8" },
      "pirate": { emoji: "üè¥‚Äç‚ò†Ô∏è", color: "#8B4513" },
      "zoomer": { emoji: "üòé", color: "#FF69B4" },
      "meme": { emoji: "üé≠", color: "#6f42c1" },
      "boomer": { emoji: "üë¥", color: "#8B0000" },
      "default": { emoji: "ü§ñ", color: "#6c757d" }
    };
    let agents_config = {};
    let currentChain = [];
    let modelInfo = {};
    let modelStatusInterval = null;

    // Tag color mapping
    const tagColors = {
      "fast": "28a745",
      "reasoning": "17a2b8",
      "small": "ffc107",
      "balanced": "6f42c1",
      "general": "6c757d",
      "high-quality": "d9534f",
      "versatile": "0078d4",
      "efficient": "20c997",
      "creative": "e83e8c",
      "accurate": "28a745",
      "unknown": "6c757d"
    };

    // --- Initialization ---
    window.onload = () => {
      loadSystemInfo();
      checkModels();
      loadAgents();
      loadAgentDropdown();
      updateSessionMemory();
      startModelStatusUpdates();
    };

    // --- Model check ---
    async function checkModels() {
      try
      {
        const res = await fetch('/models');
        const models = await res.json();
        localStorage.setItem("availableModels", JSON.stringify(models));
        if (!models.includes('phi3') || !models.includes('nomic-embed-text'))
          document.getElementById("modelWarning").style.display = "block";
      } catch (e) { console.warn("Could not check models"); }
    }

    // --- System info ---
    async function loadSystemInfo() {
      try
      {
        const res = await fetch('/system/info');
        const info = await res.json();
        window.systemInfo = info;
        if (info.ram_total_gb)
        {
          localStorage.setItem("system_ram_gb", info.ram_total_gb);
        }
      } catch (e)
      {
        console.warn("Could not load system info");
      }
    }

    // --- Add message with avatar ---
    function addMessage(text, isUser = false, agentKey = null) {
      const div = document.createElement("div");
      div.className = `message ${isUser ? 'message-user' : 'message-agent'}`;

      if (isUser)
      {
        const escaped = text.replace(/&/g, "&amp;").replace(/</g, "<").replace(/>/g, ">").replace(/\n/g, "<br>");
        div.innerHTML = `<div class="message-content">${escaped}</div>`;
      } else
      {
        const avatar = AGENT_AVATARS[ agentKey ] || AGENT_AVATARS[ "default" ];
        const agentName = agents_config[ agentKey ]?.name || "Assistant";
        const escaped = text.replace(/&/g, "&amp;").replace(/</g, "<").replace(/>/g, ">").replace(/\n/g, "<br>");
        div.innerHTML = `
          <div class="message-header">
            <span class="message-avatar">${avatar.emoji}</span>
            <span>${agentName}</span>
          </div>
          <div class="message-content">${escaped}</div>
        `;
      }

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      updateSessionMemory();
    }

    // --- Send chat message ---
    async function sendMessage() {
      const input = document.getElementById("message");
      const msg = input.value.trim();
      if (!msg) return;
      addMessage(msg, true);
      input.value = "";
      try
      {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg })
        });
        const data = await res.json();
        addMessage(data.message, false, data.agent_key);
      } catch (err)
      {
        addMessage("[System]: Error. Is Ollama running?");
      }
    }

    // --- Clear chat ---
    async function clearChat() {
      if (!confirm("Clear current chat?")) return;
      await fetch("/clear", { method: "POST" });
      chatBox.innerHTML = "";
      document.cookie = "session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      window.location.reload();
    }

    // --- Search ---
    async function searchCurrent() {
      const q = document.getElementById("searchQuery").value.trim();
      if (!q) return;
      searchResults.innerHTML = "<em>Searching current session...</em>";
      try
      {
        const res = await fetch(`/search/current?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        displaySearchResults(data.results);
      } catch (e)
      {
        searchResults.innerHTML = "<em>Search failed.</em>";
      }
    }

    async function searchGlobal() {
      const q = document.getElementById("searchQuery").value.trim();
      if (!q) return;
      searchResults.innerHTML = "<em>Searching all sessions...</em>";
      try
      {
        const res = await fetch(`/search/global?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        displaySearchResults(data.results);
      } catch (e)
      {
        searchResults.innerHTML = "<em>Search failed.</em>";
      }
    }

    function displaySearchResults(results) {
      if (!results || results.length === 0)
      {
        searchResults.innerHTML = "<em>No results found.</em>";
        return;
      }
      searchResults.innerHTML = results.map(r => {
        const content = (r.content || '').replace(/&/g, "&amp;").replace(/</g, "<").replace(/>/g, ">").replace(/\n/g, "<br>");
        return `<div style="margin-bottom:0.5rem; padding-bottom:0.5rem; border-bottom:1px solid var(--gray-200);">${content} <small style="color:var(--gray-500);">${r.session || ''} ${r.ts || ''}</small></div>`;
      }).join("");
    }

    // --- Agent Management ---
    async function loadAgents() {
      try
      {
        const res = await fetch('/agents');
        agents_config = await res.json();
        initChainBuilder();
      } catch (e)
      {
        console.error("Failed to load agents", e);
      }
    }

    async function loadAgentDropdown() {
      try
      {
        const res = await fetch('/agents');
        const agents = await res.json();
        const select = document.getElementById("agent");
        select.innerHTML = '<option value="">Auto-select Assistant</option>';
        for (const key in agents)
        {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = agents[ key ].name;
          select.appendChild(opt);
        }
      } catch (e)
      {
        console.error("Failed to load agent dropdown");
      }
    }

    // --- Model Selector ---
    async function loadModelSelector() {
      try
      {
        const res = await fetch('/models/info');
        modelInfo = await res.json();

        const container = document.getElementById("modelSelector");
        if (!container) return;

        container.innerHTML = "";

        const modelsRes = await fetch('/models');
        const availableModels = await modelsRes.json();

        availableModels.forEach(model => {
          const info = modelInfo[ model ] || {
            name: model,
            description: "No info available",
            tags: [],
            speed: "‚ùì",
            quality: "‚ùì",
            context: "?",
            size: "?",
            memory_usage: null
          };

          const isSelected = model === (document.getElementById("agentModel")?.value || "phi3");

          const modelDiv = document.createElement("div");
          modelDiv.style.padding = "0.6rem";
          modelDiv.style.borderBottom = "1px solid #eee";
          modelDiv.style.cursor = "pointer";
          modelDiv.style.background = isSelected ? "#e7f3ff" : "white";
          modelDiv.onclick = () => selectModel(model);

          const tagsHtml = info.tags.map(tag =>
            `<span style="background:#${tagColors[ tag ] || '6c757d'}; color:white; padding:0.1rem 0.4rem; border-radius:4px; font-size:0.75rem; margin-right:0.3rem;">${tag}</span>`
          ).join('');

          modelDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div>
                <strong>${info.name || model}</strong>
                ${isSelected ? '<span style="color:#0078d4; margin-left:0.5rem;">‚úì Selected</span>' : ''}
                <div style="font-size:0.85rem; color:#495057; margin:0.2rem 0;">${info.description}</div>
                <div style="margin:0.3rem 0;">${tagsHtml}</div>
              </div>
              <div style="text-align:right; min-width:120px;">
                <div><strong>Speed:</strong> ${info.speed}</div>
                <div><strong>Quality:</strong> ${info.quality}</div>
                <div style="font-size:0.8rem; color:#6c757d; margin:0.2rem 0;">${info.size} ‚Ä¢ ${info.context}</div>
                ${renderMemoryUsage(info.memory_usage, window.systemInfo)}
              </div>
            </div>
          `;

          container.appendChild(modelDiv);
        });

      } catch (e)
      {
        console.error("Failed to load model selector", e);
        document.getElementById("modelSelector").innerHTML = "<div style='padding:0.5rem; color:red;'>Failed to load models</div>";
      }
    }

    function selectModel(model) {
      let input = document.getElementById("agentModel");
      if (!input)
      {
        input = document.createElement("input");
        input.type = "hidden";
        input.id = "agentModel";
        input.name = "model";
        document.getElementById("createForm").appendChild(input);
      }
      input.value = model;
      loadModelSelector();
      showModelRecommendation(model);
    }

    function showModelRecommendation(model) {
      const info = modelInfo[ model ];
      if (!info || !info.recommended_for) return;

      const agentKey = document.getElementById("agentKey")?.value;
      if (!agentKey) return;

      const isRecommended = info.recommended_for.includes(agentKey);
      const recDiv = document.getElementById("modelRecommendation");
      if (recDiv)
      {
        recDiv.textContent = isRecommended ?
          "‚úÖ Recommended for this agent type!" :
          "‚ÑπÔ∏è Not the best fit for this agent.";
        recDiv.style.color = isRecommended ? "#28a745" : "#ffc107";
      }
    }

    function renderMemoryUsage(mem, systemInfo) {
      if (!mem)
      {
        return '<div style="font-size:0.8rem; color:#6c757d;">Memory: ?</div>';
      }

      const systemRam = systemInfo?.ram_total_gb;
      const swapInfo = getSwapRecommendation(mem, systemInfo);

      let ramColor = "#28a745";
      let ramText = `${mem.ram_min}-${mem.ram_recommended}GB RAM`;
      let swapHtml = "";

      if (swapInfo)
      {
        if (swapInfo.status === "good")
        {
          ramColor = "#28a745";
        } else if (swapInfo.status === "warning")
        {
          ramColor = "#ffc107";
          ramText += " ‚ö†Ô∏è";
        } else if (swapInfo.status === "needed")
        {
          ramColor = "#dc3545";
          ramText += " ‚ùå";
          swapHtml = `
            <button onclick="showSwapGuide('${swapInfo.os}', ${swapInfo.needed_gb})" 
                    style="font-size:0.7rem; padding:0.2rem 0.4rem; background:#0078d4; color:white; border:none; border-radius:3px; margin-top:0.2rem;">
              üíæ Setup Swap (${swapInfo.needed_gb}GB)
            </button>
          `;
        } else if (swapInfo.status === "critical")
        {
          ramColor = "#dc3545";
          ramText += " ‚ùå";
          swapHtml = `<div style="color:#dc3545; font-size:0.7rem; margin-top:0.2rem;">${swapInfo.message}</div>`;
        }
      }

      return `
        <div style="display:flex; flex-direction:column; gap:0.1rem; font-size:0.75rem;">
          <div style="color:${ramColor};">RAM: ${ramText}</div>
          <div style="color:#6c757d;">VRAM: ${mem.vram}GB</div>
          <div style="color:#6c757d;">Disk: ${mem.disk}GB</div>
          ${swapHtml}
        </div>
      `;
    }

    function getSwapRecommendation(modelMem, systemInfo) {
      if (!modelMem || !systemInfo) return null;

      const { ram_total_gb, swap_total_gb, disk_free_gb, os } = systemInfo;
      const totalVirtualMem = (ram_total_gb || 0) + (swap_total_gb || 0);
      const recommendedVirtual = modelMem.ram_recommended;
      const minimumVirtual = modelMem.ram_min;

      if (totalVirtual >= recommendedVirtual)
      {
        return {
          status: "good",
          message: "‚úÖ Sufficient virtual memory",
          action: null
        };
      }

      if (totalVirtual >= minimumVirtual)
      {
        return {
          status: "warning",
          message: "‚ö†Ô∏è Minimum met, but performance may be slow",
          action: "consider_more_swap"
        };
      }

      const neededAdditionalSwap = Math.ceil(recommendedVirtual - totalVirtual);
      const availableDisk = disk_free_gb || 0;

      if (availableDisk < neededAdditionalSwap)
      {
        return {
          status: "critical",
          message: `‚ùå Not enough disk space for required swap (${neededAdditionalSwap}GB needed, ${availableDisk}GB available)`,
          action: "insufficient_disk"
        };
      }

      return {
        status: "needed",
        message: `üîß Requires ${neededAdditionalSwap}GB additional swap`,
        action: "create_swap",
        needed_gb: neededAdditionalSwap,
        os: os
      };
    }

    // --- Create/Edit Agent ---
    function showCreateForm() {
      document.getElementById("createForm").style.display = "block";
      loadModelSelector();
    }

    function showEditForm(agentKey) {
      const agent = agents_config[ agentKey ];
      if (!agent) return;

      const form = document.getElementById("createForm");
      if (!form)
      {
        // Create form if it doesn't exist (for edit-only mode)
        createEditForm(agentKey, agent);
        return;
      }

      document.getElementById("agentKey").value = agentKey;
      document.getElementById("agentKey").disabled = true;
      document.getElementById("agentName").value = agent.name;
      document.getElementById("agentTask").value = agent.task;
      document.getElementById("agentPrompt").value = agent.system_prompt;
      document.getElementById("agentTransitions").value = agent.transitions.join(", ");

      loadModelSelector().then(() => {
        document.getElementById("agentModel").value = agent.model;
      });

      const submitBtn = form.querySelector("button[onclick='createAgent()']");
      if (submitBtn)
      {
        submitBtn.textContent = "Update Agent";
        submitBtn.onclick = () => updateAgent(agentKey);
      }

      form.style.display = "block";
      form.scrollIntoView({ behavior: "smooth" });
    }

    function createEditForm(agentKey, agent) {
      const modal = document.createElement("div");
      modal.id = "editModal";
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
      `;

      modal.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%;">
          <h3>Edit Agent: ${agent.name}</h3>
          <div style="margin: 1rem 0;">
            <label style="display: block; margin-bottom: 0.5rem;">Name:</label>
            <input type="text" id="editAgentName" value="${agent.name}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-300); border-radius: var(--border-radius);">
          </div>
          <div style="margin: 1rem 0;">
            <label style="display: block; margin-bottom: 0.5rem;">Task:</label>
            <input type="text" id="editAgentTask" value="${agent.task}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-300); border-radius: var(--border-radius);">
          </div>
          <div style="margin: 1rem 0;">
            <label style="display: block; margin-bottom: 0.5rem;">System Prompt:</label>
            <textarea id="editAgentPrompt" rows="4" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-300); border-radius: var(--border-radius);">${agent.system_prompt}</textarea>
          </div>
          <div style="margin: 1rem 0;">
            <label style="display: block; margin-bottom: 0.5rem;">Model:</label>
            <select id="editAgentModel" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-300); border-radius: var(--border-radius);"></select>
          </div>
          <div style="margin: 1rem 0;">
            <label style="display: block; margin-bottom: 0.5rem;">Transitions:</label>
            <input type="text" id="editAgentTransitions" value="${agent.transitions.join(', ')}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-300); border-radius: var(--border-radius);">
          </div>
          <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="saveEditAgent('${agentKey}')">Save Changes</button>
            <button class="btn btn-secondary" onclick="document.getElementById('editModal').remove()">Cancel</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Load models into dropdown
      loadEditModels(agent.model);
    }

    async function loadEditModels(currentModel) {
      try
      {
        const res = await fetch('/models');
        const models = await res.json();
        const select = document.getElementById("editAgentModel");
        select.innerHTML = '';
        models.forEach(model => {
          const opt = document.createElement("option");
          opt.value = model;
          opt.textContent = model;
          if (model === currentModel) opt.selected = true;
          select.appendChild(opt);
        });
      } catch (e)
      {
        console.error("Failed to load models for edit");
      }
    }

    async function saveEditAgent(agentKey) {
      const name = document.getElementById("editAgentName").value.trim();
      const task = document.getElementById("editAgentTask").value.trim();
      const prompt = document.getElementById("editAgentPrompt").value.trim();
      const model = document.getElementById("editAgentModel").value;
      const transitions = document.getElementById("editAgentTransitions").value
        .split(',').map(t => t.trim()).filter(t => t);

      if (!name || !prompt)
      {
        alert("Name and system prompt are required");
        return;
      }

      const updatedAgent = {
        name, task, system_prompt: prompt, model, transitions
      };

      try
      {
        const res = await fetch(`/agents/${agentKey}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedAgent)
        });

        if (res.ok)
        {
          alert("Agent updated successfully!");
          document.getElementById("editModal").remove();
          loadAgents();
          initChainBuilder();
        } else
        {
          const err = await res.json();
          alert("Error: " + (err.detail || "Failed to update"));
        }
      } catch (e)
      {
        alert("Update failed: " + e.message);
      }
    }

    async function createAgent() {
      const key = document.getElementById("agentKey").value.trim();
      const name = document.getElementById("agentName").value.trim();
      const task = document.getElementById("agentTask").value.trim();
      const prompt = document.getElementById("agentPrompt").value.trim();
      const model = document.getElementById("agentModel").value;
      const transitions = document.getElementById("agentTransitions").value.split(',').map(t => t.trim()).filter(t => t);

      if (!key || !name || !prompt)
      {
        alert("Fill required fields");
        return;
      }

      const res = await fetch('/agents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, name, task, system_prompt: prompt, model, transitions })
      });

      if (res.ok)
      {
        alert("Agent created!");
        document.getElementById("createForm").style.display = "none";
        loadAgents();
        loadAgentDropdown();
      } else
      {
        const err = await res.json();
        alert("Error: " + (err.detail || "Unknown"));
      }
    }

    async function updateAgent(agentKey) {
      const name = document.getElementById("agentName").value.trim();
      const task = document.getElementById("agentTask").value.trim();
      const prompt = document.getElementById("agentPrompt").value.trim();
      const model = document.getElementById("agentModel").value;
      const transitions = document.getElementById("agentTransitions").value
        .split(',').map(t => t.trim()).filter(t => t);

      if (!name || !prompt)
      {
        alert("Name and system prompt are required");
        return;
      }

      const updatedAgent = {
        name, task, system_prompt: prompt, model, transitions
      };

      try
      {
        const res = await fetch(`/agents/${agentKey}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedAgent)
        });

        if (res.ok)
        {
          alert("Agent updated successfully!");
          document.getElementById("createForm").style.display = "none";
          loadAgents();
          initChainBuilder();
        } else
        {
          const err = await res.json();
          alert("Error: " + (err.detail || "Failed to update"));
        }
      } catch (e)
      {
        alert("Update failed: " + e.message);
      }
    }

    // --- Professional Chain Builder ---
    async function initChainBuilder() {
      const coreAgents = {
        "math": { name: "Math Tutor", task: "Solve math problems", emoji: "üßÆ", color: "#28a745" },
        "code": { name: "Code Assistant", task: "Help with programming", emoji: "üíª", color: "#0078d4" },
        "writing": { name: "Writing Coach", task: "Creative writing help", emoji: "‚úçÔ∏è", color: "#17a2b8" },
        "pirate": { name: "Captain Blackbeard", task: "Speak like a pirate", emoji: "üè¥‚Äç‚ò†Ô∏è", color: "#8B4513" },
        "zoomer": { name: "Gen-Z Pal", task: "Talk like a Zoomer", emoji: "üòé", color: "#FF69B4" },
        "meme": { name: "Meme Lord", task: "Generate meme captions", emoji: "üé≠", color: "#6f42c1" },
        "boomer": { name: "Old-School Boomer", task: "Speak like a Baby Boomer", emoji: "üë¥", color: "#8B0000" }
      };

      // Update agent showcase
      const showcase = document.getElementById("agentShowcase");
      showcase.innerHTML = "";

      for (const [ key, agentInfo ] of Object.entries(coreAgents))
      {
        const cfg = agents_config[ key ] || {
          name: agentInfo.name,
          task: agentInfo.task,
          model: "phi3",
          system_prompt: "Default system prompt",
          transitions: []
        };

        const div = document.createElement("div");
        div.className = "assistant-card";

        const modelData = modelInfo[ cfg.model ];
        const swapRec = getSwapRecommendation(modelData?.memory_usage, window.systemInfo);
        let swapWarning = "";
        if (swapRec?.status === "needed")
        {
          swapWarning = `<button onclick="showSwapGuide('${swapRec.os}', ${swapRec.needed_gb})" class="assistant-btn edit" style="font-size:0.7rem; padding:0.15rem 0.4rem; margin-top:0.3rem;">üíæ Add Swap</button>`;
        }

        div.innerHTML = `
          <div class="assistant-avatar" style="background:${agentInfo.color}20; color:${agentInfo.color};">
            ${agentInfo.emoji}
          </div>
          <div class="assistant-name">${cfg.name}</div>
          <div class="assistant-task">${cfg.task}</div>
          <div class="assistant-model">üß† ${cfg.model}</div>
          ${swapWarning}
          <div class="assistant-actions">
            <button class="assistant-btn edit" onclick="showEditForm('${key}')">‚úèÔ∏è Edit</button>
          </div>
        `;
        showcase.appendChild(div);
      }

      // Add custom agents
      for (const [ key, cfg ] of Object.entries(agents_config))
      {
        if (!coreAgents[ key ])
        {
          const avatar = AGENT_AVATARS[ key ] || AGENT_AVATARS[ "default" ];
          const div = document.createElement("div");
          div.className = "assistant-card";
          div.innerHTML = `
            <div class="assistant-avatar" style="background:${avatar.color}20; color:${avatar.color};">
              ${avatar.emoji}
            </div>
            <div class="assistant-name">${cfg.name}</div>
            <div class="assistant-task">${cfg.task}</div>
            <div class="assistant-model">üß† ${cfg.model}</div>
            <div class="assistant-actions">
              <button class="assistant-btn edit" onclick="showEditForm('${key}')">‚úèÔ∏è Edit</button>
            </div>
          `;
          showcase.appendChild(div);
        }
      }

      // Initialize agent palette
      const palette = document.getElementById("agentPalette");
      palette.innerHTML = "";

      for (const [ key, agentInfo ] of Object.entries(coreAgents))
      {
        const cfg = agents_config[ key ] || { name: agentInfo.name, task: agentInfo.task, model: "phi3" };
        const card = document.createElement("div");
        card.className = "chain-agent";
        card.draggable = true;
        card.dataset.agentKey = key;

        card.innerHTML = `
          <div style="font-size:1.8rem; margin-bottom:0.5rem;">${agentInfo.emoji}</div>
          <div style="font-weight:600; font-size:0.9rem;">${cfg.name}</div>
        `;

        card.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("agentKey", key);
          card.style.opacity = "0.6";
        });

        card.addEventListener("dragend", () => {
          card.style.opacity = "1";
        });

        palette.appendChild(card);
      }

      // Add custom agents to palette
      for (const [ key, cfg ] of Object.entries(agents_config))
      {
        if (!coreAgents[ key ])
        {
          const avatar = AGENT_AVATARS[ key ] || AGENT_AVATARS[ "default" ];
          const card = document.createElement("div");
          card.className = "chain-agent";
          card.draggable = true;
          card.dataset.agentKey = key;

          card.innerHTML = `
            <div style="font-size:1.8rem; margin-bottom:0.5rem;">${avatar.emoji}</div>
            <div style="font-weight:600; font-size:0.9rem;">${cfg.name}</div>
          `;

          card.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("agentKey", key);
            card.style.opacity = "0.6";
          });

          card.addEventListener("dragend", () => {
            card.style.opacity = "1";
          });

          palette.appendChild(card);
        }
      }

      loadChainPresets();
      updateChainDisplay();
    }

    function updateChainDisplay() {
      const placeholder = document.getElementById("chainPlaceholder");
      const nodes = document.getElementById("chainNodes");
      const length = document.getElementById("chainLength");

      if (currentChain.length === 0)
      {
        placeholder.style.display = "block";
        nodes.style.display = "none";
        length.textContent = "";
      } else
      {
        placeholder.style.display = "none";
        nodes.style.display = "flex";

        nodes.innerHTML = "";
        currentChain.forEach((key, index) => {
          const avatar = AGENT_AVATARS[ key ] || AGENT_AVATARS[ "default" ];
          const cfg = agents_config[ key ] || { name: key };

          const node = document.createElement("div");
          node.className = "chain-node";
          node.innerHTML = `
            <div class="chain-avatar" style="background:${avatar.color}20; color:${avatar.color};">
              ${avatar.emoji}
              <div class="chain-step">${index + 1}</div>
            </div>
            <div class="chain-name">${cfg.name}</div>
          `;

          nodes.appendChild(node);

          if (index < currentChain.length - 1)
          {
            const arrow = document.createElement("div");
            arrow.className = "chain-arrow";
            arrow.innerHTML = "‚Üí";
            nodes.appendChild(arrow);
          }
        });

        length.textContent = `${currentChain.length} agents`;
      }
    }

    function removeFromChain(index) {
      currentChain.splice(index, 1);
      updateChainDisplay();
    }

    function clearChain() {
      if (currentChain.length === 0) return;
      if (currentChain.length > 0 && !confirm("Clear the entire chain?")) return;
      currentChain = [];
      updateChainDisplay();
    }

    function buildChainMessage() {
      if (currentChain.length === 0)
      {
        alert("‚ö†Ô∏è Please add at least one assistant to your chain.");
        return;
      }

      const userInput = document.getElementById("message").value.trim();
      if (!userInput)
      {
        alert("‚ö†Ô∏è Please enter your message first.");
        return;
      }

      const chainStr = `[CHAIN:${currentChain.join(",")}] ${userInput}`;
      document.getElementById("message").value = chainStr;
      sendMessage();
    }

    // --- Presets ---
    function saveChainPreset() {
      if (currentChain.length === 0)
      {
        alert("Build a chain first!");
        return;
      }

      const name = prompt("Preset name:", "My Chain");
      if (!name) return;

      const presets = JSON.parse(localStorage.getItem("chainPresets") || "{}");
      presets[ name ] = currentChain;
      localStorage.setItem("chainPresets", JSON.stringify(presets));

      loadChainPresets();
      alert(`Saved preset: "${name}"`);
    }

    function loadChainPresets() {
      const presets = JSON.parse(localStorage.getItem("chainPresets") || "{}");
      const list = document.getElementById("presetList");

      if (Object.keys(presets).length === 0)
      {
        list.innerHTML = "<div style='padding:0.5rem; color:#6c757d; font-style:italic;'>No presets saved</div>";
        return;
      }

      list.innerHTML = "";
      for (const [ name, chain ] of Object.entries(presets))
      {
        const item = document.createElement("div");
        item.className = "preset-card";

        const chainPreview = chain.map(key => {
          const avatar = AGENT_AVATARS[ key ] || AGENT_AVATARS[ "default" ];
          return avatar.emoji;
        }).join(" ‚Üí ");

        item.innerHTML = `
          <div class="preset-name">${name}</div>
          <div class="preset-chain">${chainPreview}</div>
          <div class="preset-actions">
            <button class="btn btn-secondary" style="padding:0.3rem 0.6rem; font-size:0.8rem;" onclick="applyPreset('${name}')">Use</button>
            <button class="btn btn-danger" style="padding:0.3rem 0.6rem; font-size:0.8rem;" onclick="deletePreset('${name}')">üóëÔ∏è</button>
          </div>
        `;
        list.appendChild(item);
      }
    }

    function applyPreset(name) {
      const presets = JSON.parse(localStorage.getItem("chainPresets") || "{}");
      if (presets[ name ])
      {
        currentChain = [ ...presets[ name ] ];
        updateChainDisplay();
      }
    }

    function deletePreset(name) {
      if (!confirm(`Delete preset "${name}"?`)) return;
      const presets = JSON.parse(localStorage.getItem("chainPresets") || "{}");
      delete presets[ name ];
      localStorage.setItem("chainPresets", JSON.stringify(presets));
      loadChainPresets();
    }

    // --- Export/Import ---
    function exportChainPresets() {
      const presets = JSON.parse(localStorage.getItem("chainPresets") || "{}");
      if (Object.keys(presets).length === 0)
      {
        alert("No presets to export!");
        return;
      }

      const dataStr = JSON.stringify(presets, null, 2);
      const dataBlob = new Blob([ dataStr ], { type: "application/json" });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "agent_chains.json";
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);
    }

    function importChainPresets(event) {
      const file = event.target.files[ 0 ];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try
        {
          const imported = JSON.parse(e.target.result);
          if (typeof imported !== "object" || imported === null)
          {
            throw new Error("Invalid JSON structure");
          }
          for (const [ name, chain ] of Object.entries(imported))
          {
            if (!Array.isArray(chain))
            {
              throw new Error(`Preset "${name}" is not an array`);
            }
            if (chain.some(agent => typeof agent !== "string"))
            {
              throw new Error(`Preset "${name}" contains non-string agents`);
            }
          }

          const existing = JSON.parse(localStorage.getItem("chainPresets") || "{}");
          const merged = { ...existing, ...imported };
          localStorage.setItem("chainPresets", JSON.stringify(merged));

          alert(`Successfully imported ${Object.keys(imported).length} preset(s)!`);
          loadChainPresets();
        } catch (err)
        {
          alert("Failed to import: Invalid JSON file.\n\n" + err.message);
        }
        event.target.value = "";
      };
      reader.readAsText(file);
    }

    // --- Swap Guide ---
    function showSwapGuide(os, neededGB) {
      const title = document.getElementById("swapGuideTitle");
      const content = document.getElementById("swapGuideContent");

      let guideHTML = "";

      if (os === "linux")
      {
        guideHTML = `
          <h4>Linux Swap File Setup</h4>
          <p><strong>Warning:</strong> This requires sudo access. Backup important data first.</p>
          
          <ol>
            <li><strong>Check current swap:</strong><br>
                <code>sudo swapon --show</code></li>
            
            <li><strong>Create swap file (${neededGB}GB):</strong><br>
                <code>sudo fallocate -l ${neededGB}G /swapfile</code></li>
            
            <li><strong>Set permissions:</strong><br>
                <code>sudo chmod 600 /swapfile</code></li>
            
            <li><strong>Make it swap:</strong><br>
                <code>sudo mkswap /swapfile</code></li>
            
            <li><strong>Enable swap:</strong><br>
                <code>sudo swapon /swapfile</code></li>
            
            <li><strong>Make permanent (optional):</strong><br>
                <code>echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab</code></li>
          </ol>
          
          <p><strong>To remove later:</strong><br>
             <code>sudo swapoff /swapfile && sudo rm /swapfile</code></p>
        `;
      }

      else if (os === "darwin")
      {
        guideHTML = `
          <h4>macOS Virtual Memory</h4>
          <p>macOS manages swap automatically, but you can optimize:</p>
          
          <ol>
            <li><strong>Check current swap usage:</strong><br>
                <code>vm_stat</code></li>
            
            <li><strong>Free up disk space:</strong><br>
                macOS needs free disk space to create swap files automatically.</li>
            
            <li><strong>Close unnecessary apps:</strong><br>
                Reduce memory pressure to minimize swap usage.</li>
            
            <li><strong>Consider upgrading RAM:</strong><br>
                macOS swap performance is limited by SSD speed.</li>
          </ol>
          
          <p><strong>Note:</strong> Manual swap file creation is not recommended on macOS.</p>
        `;
      }

      else if (os === "windows")
      {
        guideHTML = `
          <h4>Windows Page File Setup</h4>
          <p>Windows calls swap "page file". Here's how to increase it:</p>
          
          <ol>
            <li>Press <code>Win + R</code>, type <code>sysdm.cpl</code>, press Enter</li>
            <li>Go to <strong>Advanced</strong> tab ‚Üí <strong>Settings</strong> (Performance)</li>
            <li>Go to <strong>Advanced</strong> tab ‚Üí <strong>Change</strong> (Virtual memory)</li>
            <li>Uncheck "Automatically manage paging file size"</li>
            <li>Select your system drive (usually C:)</li>
            <li>Select <strong>Custom size</strong></li>
            <li><strong>Initial size:</strong> ${(neededGB * 1024) + 1024} MB</li>
            <li><strong>Maximum size:</strong> ${(neededGB * 1024) + 2048} MB</li>
            <li>Click <strong>Set</strong> ‚Üí <strong>OK</strong></li>
            <li>Restart your computer</li>
          </ol>
          
          <p><strong>Current page file location:</strong><br>
             Usually <code>C:\\pagefile.sys</code></p>
        `;
      }

      else
      {
        guideHTML = `
          <p>Automatic swap setup guide not available for your OS (${os}).</p>
          <p><strong>General recommendations:</strong></p>
          <ul>
            <li>Ensure you have at least ${neededGB}GB of free disk space</li>
            <li>Close unnecessary applications to free RAM</li>
            <li>Consider using smaller models that fit your available memory</li>
          </ul>
        `;
      }

      title.textContent = `Swap Setup Guide for ${os.toUpperCase()} (${neededGB}GB)`;
      content.innerHTML = guideHTML;
      document.getElementById("swapModal").style.display = "flex";
    }

    // --- Model Status ---
    async function updateModelStatus() {
      try
      {
        const res = await fetch('/models/status');
        const status = await res.json();

        const statusItems = document.querySelectorAll('.status-value');
        if (statusItems.length >= 3)
        {
          // Active Models
          let loadedModelsHtml = status.loaded_models.length > 0 ?
            status.loaded_models.map(model => {
              const info = modelInfo[ model ] || { name: model };
              return info.name || model;
            }).join(', ') : 'None';
          statusItems[ 0 ].textContent = loadedModelsHtml;

          // RAM Usage
          let ramColor = "status-good";
          if (status.ram_percent_used > 80) ramColor = "status-danger";
          else if (status.ram_percent_used > 60) ramColor = "status-warning";
          statusItems[ 1 ].textContent = `${status.ram_percent_used || '?'}%`;
          statusItems[ 1 ].className = `status-value ${ramColor}`;

          // Capacity
          statusItems[ 2 ].textContent = `${status.loaded_models.length}/${status.max_models}`;
        }
      } catch (e)
      {
        console.warn("Could not update model status", e);
      }
    }

    function startModelStatusUpdates() {
      updateModelStatus();
      if (modelStatusInterval) clearInterval(modelStatusInterval);
      modelStatusInterval = setInterval(updateModelStatus, 3000);
    }

    window.addEventListener('beforeunload', () => {
      if (modelStatusInterval) clearInterval(modelStatusInterval);
    });

    // --- Session preview ---
    async function updateSessionMemory() {
      try
      {
        const res = await fetch("/session");
        const data = await res.json();
        if (data.history.length === 0)
        {
          return;
        }
      } catch (e)
      {
      }
    }

    // --- Enter key triggers ---
    document.getElementById("message").addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey)
      {
        e.preventDefault();
        sendMessage();
      }
    });
    document.getElementById("searchQuery").addEventListener("keypress", (e) => {
      if (e.key === "Enter") searchCurrent();
    });
  </script>
</body>

</html>